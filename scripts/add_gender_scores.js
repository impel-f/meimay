/**
 * add_gender_scores.js
 *
 * 分類タグのルールベースで kanji_data.json に
 * 「男のおすすめ度」「女のおすすめ度」を追加するスクリプト。
 *
 * スコア: 0〜100（高いほど推奨）
 * 基準値: 50（中性）
 * タグのオフセット値を合算してクランプ。
 *
 * Usage: node scripts/add_gender_scores.js
 */

const fs = require('fs');
const path = require('path');

const DATA_PATH = path.join(__dirname, '../public/data/kanji_data.json');

// =========================================================
// 分類タグ → [男オフセット, 女オフセット]
// 正 = そちらの性別に有利、負 = 不利
// =========================================================
const TAG_GENDER_OFFSETS = {
  // ── 強く男性寄り ──
  '【リーダー】':   [30, -10],
  '【強さ】':       [40, -20],
  '【壮大】':       [25, -10],
  '【勇敢】':       [40, -20],
  '【強靭】':       [40, -30],
  '【武器】':       [40, -30],
  '【スピード】':   [20, -10],
  '【スポーツ】':   [25, -15],
  '【名誉】':       [15,  -5],
  '【車】':         [30, -20],

  // ── やや男性寄り ──
  '【意志】':       [20,   0],
  '【行動】':       [20,   0],
  '【誠実】':       [15,   0],
  '【技能】':       [15,  -5],
  '【技術】':       [20, -10],
  '【規律】':       [15,  -5],
  '【繁栄】':       [10,   0],
  '【成功】':       [20, -10],
  '【守護】':       [15,  -5],
  '【上昇】':       [15,  -5],
  '【生命力】':     [10,   5],
  '【信頼】':       [10,   0],
  '【飛躍】':       [10,  -5],
  '【計画】':       [10,  -5],
  '【忍耐】':       [10,  -5],
  '【エネルギー】': [10,  -5],
  '【名声】':       [10,  -5],
  '【情熱】':       [10,   5],
  '【活力】':       [10,  -5],
  '【向上】':       [ 5,   0],
  '【向上心】':     [ 5,   0],
  '【努力】':       [ 5,   0],
  '【精神】':       [ 5,   0],
  '【優秀】':       [10,   0],
  '【知性】':       [ 5,   0],
  '【才能】':       [ 5,   0],
  '【徳】':         [ 5,   0],
  '【模範】':       [ 5,   0],
  '【自立】':       [ 5,   0],
  '【着実】':       [ 5,   0],
  '【動物】':       [ 5,   0],
  '【太陽】':       [ 5,   0],
  '【宇宙】':       [ 5,   0],
  '【海】':         [10,   0],
  '【創造】':       [ 5,   5],

  // ── 強く女性寄り ──
  '【美】':         [-30,  40],
  '【華やか】':     [-20,  35],
  '【しなやか】':   [-20,  30],
  '【可愛らしい】': [-30,  40],
  '【繊細】':       [-20,  30],
  '【優雅】':       [-20,  35],
  '【愛】':         [-15,  30],

  // ── やや女性寄り ──
  '【慈愛】':       [-10,  20],
  '【安らぎ】':     [-10,  20],
  '【輝き】':       [ -5,  20],
  '【情緒】':       [-10,  20],
  '【洗練】':       [-10,  20],
  '【宝石】':       [-15,  25],
  '【清らか】':     [-10,  15],
  '【純粋】':       [-10,  15],
  '【包容力】':     [-10,  15],
  '【家族】':       [ -5,  10],
  '【家庭】':       [-10,  15],
  '【美徳】':       [ -5,  10],
  '【穏やか】':     [-10,  15],
  '【絆】':         [ -5,  10],
  '【円満】':       [ -5,  10],
  '【明るさ】':     [ -5,  10],
  '【神秘】':       [ -5,  10],
  '【豊か】':       [ -5,  10],
  '【豊かさ】':     [ -5,  10],
  '【色彩】':       [ -5,  15],
  '【芸術】':       [ -5,  10],
  '【音楽】':       [ -5,  10],
  '【謙虚】':       [ -5,   5],
  '【調和】':       [ -5,  10],
  '【平和】':       [ -5,   5],
  '【感謝】':       [ -5,   5],
  '【静寂】':       [ -5,   5],
  '【実り】':       [ -5,  10],
  '【幸福】':       [ -5,  10],
  '【安定】':       [ -5,   5],
  '【品格】':       [  0,   5],

  // ── ほぼ中性 ──
  '【自然】':       [0, 0],
  '【伝統】':       [0, 0],
  '【人間関係】':   [0, 0],
  '【高貴】':       [0, 0],
  '【希望】':       [0, 0],
  '【未来】':       [0, 0],
  '【継続】':       [0, 0],
  '【成長】':       [0, 0],
  '【健康】':       [0, 0],
  '【長寿】':       [0, 0],
  '【社交】':       [0, 0],
  '【社交的】':     [0, 0],
  '【個性】':       [0, 0],
  '【文化】':       [0, 0],
  '【言葉】':       [0, 0],
  '【始まり】':     [0, 0],
  '【自由】':       [0, 0],
  '【数】':         [0, 0],
  '【教養】':       [0, 0],
  '【時間】':       [0, 0],
  '【生活】':       [0, 0],
  '【経験】':       [0, 0],
  '【その他】':     [0, 0],
  '【幸運】':       [0, 0],
  '【和風】':       [0, 0],
  '【方位】':       [0, 0],
  '【現在】':       [0, 0],
  '【光】':         [0, 0],
  '【国際的】':     [0, 0],
  '【運命】':       [0, 0],
  '【寛大】':       [0, 0],
  '【唯一】':       [0, 0],
  '【宗教】':       [0, 0],
  '【教育】':       [0, 0],
  '【性格】':       [0, 0],
  '【形状】':       [0, 0],
  '【スポーツ】':   [25, -15],
  '【エネルギー】': [10,  -5],
};

// =========================================================
// スコア計算
// =========================================================
function calcGenderScores(bunrui) {
  var BASE = 50;
  var maleOffset = 0;
  var femaleOffset = 0;

  var tags = (bunrui || '').match(/【[^】]+】/g) || [];
  tags.forEach(function(tag) {
    var offsets = TAG_GENDER_OFFSETS[tag];
    if (offsets) {
      maleOffset += offsets[0];
      femaleOffset += offsets[1];
    }
    // 未知タグはオフセット 0（中性）
  });

  var maleScore = Math.max(0, Math.min(100, BASE + maleOffset));
  var femaleScore = Math.max(0, Math.min(100, BASE + femaleOffset));
  return { male: maleScore, female: femaleScore };
}

// =========================================================
// メイン処理
// =========================================================
var raw = fs.readFileSync(DATA_PATH, 'utf8');
var data = JSON.parse(raw);

var stats = { updated: 0, skipped: 0 };
var tagsMissing = {};

data.forEach(function(entry) {
  // 既知外タグのログ収集
  var bunrui = entry['分類'] || '';
  var tags = bunrui.match(/【[^】]+】/g) || [];
  tags.forEach(function(tag) {
    if (!TAG_GENDER_OFFSETS.hasOwnProperty(tag)) {
      tagsMissing[tag] = (tagsMissing[tag] || 0) + 1;
    }
  });

  var scores = calcGenderScores(bunrui);
  entry['男のおすすめ度'] = scores.male;
  entry['女のおすすめ度'] = scores.female;
  stats.updated++;
});

fs.writeFileSync(DATA_PATH, JSON.stringify(data, null, 2), 'utf8');

console.log('完了:');
console.log('  更新レコード数:', stats.updated);
if (Object.keys(tagsMissing).length > 0) {
  console.log('  未定義タグ（中性として処理）:', JSON.stringify(tagsMissing, null, 2));
} else {
  console.log('  未定義タグ: なし');
}

// サンプル確認
console.log('\n--- サンプル出力 (先頭5件) ---');
data.slice(0, 5).forEach(function(d) {
  console.log(d['漢字'], '分類:', d['分類']);
  console.log('  男のおすすめ度:', d['男のおすすめ度'], '女のおすすめ度:', d['女のおすすめ度']);
});
