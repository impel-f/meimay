/**
 * enhance_kanji_fields.js
 *
 * 以下のフィールドを追加・更新する：
 *  1. 常用漢字        boolean
 *  2. 不適切フラグ    見直し（真に不適切なもののみ）
 *  3. おすすめ度      再スコアリング
 *  4. 止め字おすすめ度 0-100
 *  5. 頭字おすすめ度   0-100
 *  6. 名乗り_メジャー  string（従来の伝統名のり全体 → 初期値）
 *  7. 名乗り_マイナー  string（空 → 手動/次フェーズで整備）
 *
 * Usage: node scripts/enhance_kanji_fields.js
 */

const fs = require('fs');
const path = require('path');

const DATA_PATH = path.join(__dirname, '../public/data/kanji_data.json');

// =========================================================
// 1. 常用漢字 2136字（平成22年/2010年告示）
//    ※出典: 文部科学省告示 - 要検証の場合は公式PDFと照合のこと
//    ネットアクセス不可のため記憶ベースで収録。
//    精度向上は公式PDFとの照合で随時補完してください。
// =========================================================
const JOYO_STR =
  // ── ア行 ──────────────────────────────────────────
  '亜哀挨愛曖悪握圧扱宛嵐安案暗' +
  '以衣位囲医依委威為畏胃尉異移萎偉椅彙意違維慰遺緯域育一壱逸芋引印因咽員院陰隠飲韻' +
  '右宇羽雨唄鬱畝浦運雲' +
  '営栄映泳英瑛衛詠鋭液益疫易駅悦謁越閲円延沿炎怨宴媛援園煙猿遠鉛塩演縁艶' +
  '汚王凹応往旺欧殴桜翁奥押横岡屋億憶臆虞乙俺卸恩温穏音' +
  // ── カ行 ──────────────────────────────────────────
  '下化火仮何花佳価果河苛科架夏家荷華菓貨渦過嫁暇禍話我画臥芽蛾賀雅餓' +
  '介回灰会快戒改怪拐悔海界皆械絵開階塊楷解壊懐諧貝外劾害崖慨概涯蓋該骸' +
  '各角拡核格確覚較滑渇割活褐完官冠巻観貫環慣歓缶管関含岩頑顔丸' +
  '感冠寛堪棺款漢緩勧換敢乾陥干刊汗看寒願眼幹監株刈川学岳楽額' +
  '企基奇寄規喜幾機希揮旗器気岐帰既期棋鬼亀偽義議宜欺疑儀戯技犠擬' +
  '吉喫客脚逆虐境強教協恐業橋挟況供共凶胸興局曲極玉京競鏡響驚仰' +
  '勤均禁緊謹金近拒去巨居許虚拠挙距漁魚御掘窟屈熊' +
  // ── サ行 ──────────────────────────────────────────
  '差作坂傘砂才再菜細彩済載罪際妻歳在砕最裁債催惨昨策索搾冊刷察撮殺雑' +
  '三産参山散残算桟酸讃暫' +
  '士子氏市四仕史寺示糸試視師姿詩紙思至死止私司志使指自支枝賜誌施歯' +
  '色識式失室実七執者社写捨車赦謝斜邪蛇若' +
  '主守取首酒朱珠趣周株舟手種殊' +
  '所初書女諸処助序暑渚叙署緒' +
  '小少昇商消照焦象賞証丈常情傷省縄正声神性星政青西清盛誓成生世制製精聖勢整税静' +
  '心辛信真深紳審進臣親新芯' +
  '酢推水睡穂髄崇数素寸' +
  // ── タ行 ──────────────────────────────────────────
  '他多太田打大' +
  '代第台題対体態待貸替退滞堆怠帯袋逮' +
  '卓宅択炊単炭短旦探誕端担弾淡段暖' +
  '知地池血千値恥遅竹畜逐秩窒致置' +
  '貯著注宙柱忠抽昼虫調長丁帳腸頂重鳥潮超跳町朝' +
  '賃鎮沈陳通痛' +
  '低定停庭的帝提貞偵点天転典店添展' +
  '土図度途登都吐渡動同道導童胴' +
  '得徳特毒独読豚頓' +
  // ── ナ行 ──────────────────────────────────────────
  '奈南名内' +
  '似荷肉二日入乳' +
  '年念根音脳悩農' +
  // ── ハ行 ──────────────────────────────────────────
  '波把覇破馬葉' +
  '配排敗背廃肺拝賠白泊博薄' +
  '反半班販板般犯判繁版飯' +
  '比被皮費悲秘避批疲微飛非備美鼻筆匹百' +
  '表票評氷標描漂' +
  '父不普布符府付負富婦夫赴腐怖浮' +
  '風封覆福服複伏復腹幅' +
  '文分平兵閉幣弊塀柄' +
  '保歩補捕方法宝報亡縫邦褒訪帽飽泡包棒芳奉肪' +
  '暮墓模簿本' +
  // ── マ行 ──────────────────────────────────────────
  '磨麻枚毎幕満漫慢万' +
  '見身実味無夢務目命名木模望' +
  '問門聞紋' +
  // ── ヤ行 ──────────────────────────────────────────
  '野矢約役訳薬焼' +
  '油由輸' +
  '与予余用要養' +
  // ── ラ行 ──────────────────────────────────────────
  '来頼雷利理里離陸旅慮流留類' +
  '礼例列路露炉老呂' +
  // ── ワ行 ──────────────────────────────────────────
  '話和湾' +
  // ── カテゴリ補完（上記で漏れやすい常用漢字）───────────────
  // 数字・序数
  '零一二三四五六七八九十百千万億兆' +
  // 時間・暦
  '年月日時分秒週暦元旦朝昼夜春夏秋冬' +
  // 方角・位置
  '東西南北上下左右前後内外中央' +
  // 自然・地形
  '天地空海山川谷野林森島橋道' +
  // 気象
  '雨雪風雲霧霜霞雷虹嵐波潮' +
  // 植物系
  '草木花葉根実芽枝幹竹松梅柳菊蓮' +
  // 動物系
  '犬猫鳥魚牛馬羊豚猿虎亀蛇虫' +
  // 身体
  '頭顔首肩胸腹背骨肉皮体' +
  // 家族
  '父母兄弟姉妹夫婦祖孫親族' +
  // 色彩
  '赤青黄緑白黒灰茶紫' +
  // 基本動詞・名詞(読み書き学習系)
  '力刀弓矢石金銀銅鉄車船電' +
  // 学習・生活
  '学校先生教科書本文字語言食米麦茶酒水国家村区都市男女子' +
  // ── 重要補完（各行で漏れた常用漢字）─────────────────────
  // ア行追加: 永(えい)
  '永' +
  // カ行追加: 加今久
  '加今久' +
  // ケ行（景計茎系形型恵傾携継蛍劇撃激敬警掲渓経憩）
  '景計茎系形型恵傾携継蛍劇撃激景敬警掲渓経憩' +
  // ゲン行（元幻言玄原現減限厳）
  '元幻玄原現減限厳' +
  // コ行（己古戸個固故枯後語誤呼庫虎誇湖）
  '己古戸個固故枯後語誤呼庫虎誇湖' +
  // コウ行追加（口工公光行功交孝向効江広康荒）
  '口工公光行功交孝向効江広康荒' +
  // サ行追加: 申出秀
  '申出秀' +
  // シュ行追加: 出収集習衆州就修
  '収集習衆州就修' +
  // ジン行追加: 仁人
  '仁人' +
  // ナ行追加: 仁人に合わせ
  '友' +
  // ハ行追加: 必夕
  '必夕' +
  // ミ行追加: 民未末
  '民未末' +
  // タ行追加: 立当次等切全明良
  '立当次等切全明良' +
  // レイ行追加: 令
  '令' +
  // ラ行追加: 了良君
  '了君' +
  // ケイ追加（欠穴決潔傑結）
  '穴欠決潔傑結' +
  // その他確実な常用漢字（コ行・ケン行等）
  '権建研健験険件見献犬剣絹県倹検賢遣' +
  // 求球給旧救急休究吸及宮牛
  '求球給旧救急休究吸及宮' +
  // 食植触飾辱
  '飾触食植' +
  // 占奴矛斥甲
  '占矛斥甲更刑' +
  // その他の常用漢字（再補完）
  '翠髄骨谷酷告刻黒' +
  '';


const JOYO = new Set(JOYO_STR);

// =========================================================
// 2. 真に不適切な名付け漢字（約40字）
//    基準：死・病・暴力・呪い・不浄を直接表す
// =========================================================
const TRULY_INAPPROPRIATE = new Set(
  '死殺亡毒凶病呪鬼狂淫虐殴暴囚奴廃滅喪葬棺骸禍惨魔怨罪獄蔑憎奪盗詐欺刑恨醜卑疫腐臭屍'
);

// =========================================================
// 3. 止め字おすすめ度 高リスト（0-100）
//    女の子・男の子でよく使われる止め字
// =========================================================
const TOME_HIGH = new Set('子美花香菜奈穂帆乃実咲絵里羽葉音海波愛結萌恵渚沙夏春雪柚葵弦弥太郎介輔助人斗雄夫男朗');
const TOME_LOW  = new Set('一二三四五六七八九十百千万大小中高国天空世');

// =========================================================
// 4. 頭字おすすめ度 高リスト
//    名前の最初の文字によく使われるもの
// =========================================================
const KASHIRA_HIGH = new Set('一大高太光明和雄健正輝翔悠海陽颯蒼優斗仁颯茉咲花葵桃杏愛梓彩彩綾亜');
const KASHIRA_LOW  = new Set('子郎介輔助乃穂帆羽葉尾末末');

// =========================================================
// メイン処理
// =========================================================
const raw  = fs.readFileSync(DATA_PATH, 'utf8');
const data = JSON.parse(raw);

// スコア変化を記録
let joyoCount = 0, trulyBadCount = 0, unflagCount = 0;

data.forEach(function(entry) {
  const kanji = entry['漢字'];
  const bunrui = entry['分類'] || '';
  const tags   = bunrui.match(/【[^】]+】/g) || [];

  // ── 常用漢字フラグ ──────────────────────────────
  const isJoyo = JOYO.has(kanji);
  entry['常用漢字'] = isJoyo;
  if (isJoyo) joyoCount++;

  // ── 不適切フラグ見直し ──────────────────────────
  const wasFlagged = entry['不適切フラグ'] === 1;
  const isTrulyBad = TRULY_INAPPROPRIATE.has(kanji);
  entry['不適切フラグ'] = isTrulyBad ? 1 : 0;
  if (wasFlagged && !isTrulyBad) unflagCount++;
  if (isTrulyBad) trulyBadCount++;

  // ── おすすめ度 再スコアリング ─────────────────────
  // 以前は不適切フラグ=1 → おすすめ度=0 が多数あった
  // 見直し後：フラグが外れたものはおすすめ度をタグベースで再計算
  if (!isTrulyBad) {
    const currentScore = entry['おすすめ度'];
    if (currentScore === 0 && wasFlagged) {
      // 真に不適切でなかったのに0スコアだったもの → タグから推定再計算
      const tagScore = calcScoreFromTags(tags, isJoyo);
      entry['おすすめ度'] = tagScore;
    }
    // 元々0ではなかったものはそのまま（既存スコアを尊重）
  } else {
    entry['おすすめ度'] = 0;
  }

  // ── 止め字おすすめ度 ──────────────────────────────
  entry['止め字おすすめ度'] = calcTomeScore(kanji, tags, entry['女のおすすめ度']);

  // ── 頭字おすすめ度 ────────────────────────────────
  entry['頭字おすすめ度'] = calcKashiraScore(kanji, tags, entry['男のおすすめ度']);

  // ── 名乗り分割 ────────────────────────────────────
  // 現時点では 伝統名のり の全読みを メジャー に入れ、マイナーは空
  // （第2フェーズで頻度データ等をもとに分類予定）
  const rawNamori = (entry['伝統名のり'] || '').trim();
  entry['名乗り_メジャー'] = rawNamori;
  entry['名乗り_マイナー'] = '';
});

// =========================================================
// スコア計算ヘルパー
// =========================================================
function calcScoreFromTags(tags, isJoyo) {
  // タグ分類から暫定おすすめ度を算出（15-45の範囲）
  // 旧来の不適切扱いだったが実際は「使いにくい」程度の漢字
  let score = isJoyo ? 30 : 15;
  const goodTags = new Set(['【美しさ】','【自然】','【希望】','【優しさ】','【知性】','【誠実】','【品格】']);
  const neutralTags = new Set(['【伝統】','【安定】','【精神】','【明るさ】','【水】']);
  tags.forEach(function(t) {
    if (goodTags.has(t)) score += 5;
    else if (neutralTags.has(t)) score += 2;
  });
  return Math.min(45, score); // 上限45（低スコア帯）
}

function calcTomeScore(kanji, tags, femaleScore) {
  // ベース: 50
  let score = 50;

  if (TOME_HIGH.has(kanji)) score = 85;
  else if (TOME_LOW.has(kanji)) score = 15;
  else {
    // タグ・女性スコアから推定
    // 女性向け・美しさ系 → 止め字に向く
    if (tags.includes('【美しさ】')) score += 15;
    if (tags.includes('【優しさ】')) score += 10;
    if (femaleScore >= 70) score += 10;
    if (tags.includes('【力強さ】')) score -= 10;
    if (tags.includes('【リーダー】')) score -= 5;
    if (tags.includes('【成功】')) score -= 5;
  }
  return Math.max(0, Math.min(100, score));
}

function calcKashiraScore(kanji, tags, maleScore) {
  // ベース: 50
  let score = 50;

  if (KASHIRA_HIGH.has(kanji)) score = 85;
  else if (KASHIRA_LOW.has(kanji)) score = 15;
  else {
    // 力強さ・知性・リーダー系 → 頭字に向く
    if (tags.includes('【力強さ】')) score += 15;
    if (tags.includes('【リーダー】')) score += 10;
    if (tags.includes('【成功】')) score += 5;
    if (maleScore >= 70) score += 5;
    if (tags.includes('【美しさ】')) score -= 10;
    if (tags.includes('【優しさ】')) score -= 5;
  }
  return Math.max(0, Math.min(100, score));
}

// =========================================================
// 保存
// =========================================================
fs.writeFileSync(DATA_PATH, JSON.stringify(data, null, 2), 'utf8');

console.log('完了: 全', data.length, '件 更新');
console.log('常用漢字フラグ=true:', joyoCount, '件');
console.log('真に不適切フラグ=1:', trulyBadCount, '件（旧:', 1563, '件から縮小）');
console.log('フラグ解除:', unflagCount, '件（低スコアに変更）');

console.log('\n--- サンプル確認 ---');
['花', '一', '刀', '智', '愛', '月', '死', '区', '毛'].forEach(function(k) {
  var e = data.find(function(d){ return d['漢字'] === k; });
  if (e) {
    console.log(
      k,
      '| 常用:', e['常用漢字'],
      '| 不適切:', e['不適切フラグ'],
      '| おすすめ:', e['おすすめ度'],
      '| 止め字:', e['止め字おすすめ度'],
      '| 頭字:', e['頭字おすすめ度'],
      '| 名乗りM:', (e['名乗り_メジャー']||'').slice(0,20)
    );
  }
});

// フィールド確認
const sample = data.find(d => d['漢字'] === '一');
console.log('\n=== 一 全フィールド ===');
console.log(JSON.stringify(sample, null, 2));
