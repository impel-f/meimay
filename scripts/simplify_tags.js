/**
 * simplify_tags.js
 *
 * 119種の旧分類タグを IMAGE_TAGS の15種に集約し、
 * 男女おすすめ度も再計算する。
 *
 * Usage: node scripts/simplify_tags.js
 */

const fs = require('fs');
const path = require('path');

const DATA_PATH = path.join(__dirname, '../public/data/kanji_data.json');

// =========================================================
// 旧タグ → 新タグ（複数可）のマッピング
// 新タグは IMAGE_TAGS の label に完全一致させる
// =========================================================
const OLD_TO_NEW = {
  // ── 自然 ──
  '【自然】':       ['【自然】'],
  '【動物】':       ['【自然】'],
  '【宇宙】':       ['【自然】'],
  '【生命力】':     ['【自然】', '【力強さ】'],

  // ── 明るさ ──
  '【明るさ】':     ['【明るさ】'],
  '【輝き】':       ['【明るさ】'],
  '【太陽】':       ['【明るさ】'],
  '【光】':         ['【明るさ】'],

  // ── 水 ──
  '【海】':         ['【水】'],
  '【清らか】':     ['【水】'],

  // ── 力強さ ──
  '【強さ】':       ['【力強さ】'],
  '【強靭】':       ['【力強さ】'],
  '【勇敢】':       ['【力強さ】'],
  '【武器】':       ['【力強さ】'],
  '【行動】':       ['【力強さ】'],
  '【意志】':       ['【力強さ】'],
  '【活力】':       ['【力強さ】'],
  '【スピード】':   ['【力強さ】'],
  '【スポーツ】':   ['【力強さ】'],
  '【忍耐】':       ['【力強さ】'],
  '【飛躍】':       ['【力強さ】'],
  '【上昇】':       ['【力強さ】'],
  '【エネルギー】': ['【力強さ】'],
  '【健康】':       ['【力強さ】'],
  '【情熱】':       ['【力強さ】', '【精神】'],

  // ── 優しさ ──
  '【慈愛】':       ['【優しさ】'],
  '【愛】':         ['【優しさ】'],
  '【安らぎ】':     ['【優しさ】'],
  '【家族】':       ['【優しさ】'],
  '【家庭】':       ['【優しさ】'],
  '【絆】':         ['【優しさ】'],
  '【包容力】':     ['【優しさ】'],
  '【円満】':       ['【優しさ】'],
  '【感謝】':       ['【優しさ】'],
  '【穏やか】':     ['【優しさ】'],
  '【人間関係】':   ['【優しさ】'],
  '【寛大】':       ['【優しさ】'],

  // ── 知性 ──
  '【知性】':       ['【知性】'],
  '【才能】':       ['【知性】'],
  '【芸術】':       ['【知性】'],
  '【音楽】':       ['【知性】'],
  '【創造】':       ['【知性】'],
  '【教養】':       ['【知性】'],
  '【言葉】':       ['【知性】'],
  '【技能】':       ['【知性】'],
  '【技術】':       ['【知性】'],
  '【経験】':       ['【知性】'],
  '【教育】':       ['【知性】'],
  '【国際的】':     ['【知性】'],
  '【優秀】':       ['【知性】', '【成功】'],

  // ── 誠実 ──
  '【誠実】':       ['【誠実】'],
  '【信頼】':       ['【誠実】'],
  '【徳】':         ['【誠実】'],
  '【美徳】':       ['【誠実】'],
  '【謙虚】':       ['【誠実】'],
  '【模範】':       ['【誠実】'],
  '【着実】':       ['【誠実】'],

  // ── 品格 ──
  '【品格】':       ['【品格】'],
  '【高貴】':       ['【品格】'],
  '【優雅】':       ['【品格】'],
  '【洗練】':       ['【品格】'],
  '【しなやか】':   ['【品格】'],
  '【神秘】':       ['【品格】', '【精神】'],
  '【情緒】':       ['【品格】', '【美しさ】'],

  // ── 伝統 ──
  '【伝統】':       ['【伝統】'],
  '【和風】':       ['【伝統】'],
  '【文化】':       ['【伝統】'],
  '【数】':         ['【伝統】'],
  '【宗教】':       ['【伝統】'],
  '【方位】':       ['【伝統】'],

  // ── 美しさ ──
  '【美】':         ['【美しさ】'],
  '【華やか】':     ['【美しさ】'],
  '【宝石】':       ['【美しさ】'],
  '【色彩】':       ['【美しさ】'],
  '【可愛らしい】': ['【美しさ】'],
  '【繊細】':       ['【美しさ】'],

  // ── 成功 ──
  '【成功】':       ['【成功】'],
  '【繁栄】':       ['【成功】'],
  '【名誉】':       ['【成功】'],
  '【名声】':       ['【成功】'],
  '【向上】':       ['【成功】'],
  '【向上心】':     ['【成功】'],
  '【努力】':       ['【成功】'],
  '【上昇】':       ['【成功】', '【力強さ】'],  // 重複上書きされるが問題なし

  // ── 安定 ──
  '【安定】':       ['【安定】'],
  '【継続】':       ['【安定】'],
  '【規律】':       ['【安定】'],
  '【調和】':       ['【安定】'],
  '【平和】':       ['【安定】'],
  '【長寿】':       ['【安定】'],
  '【生活】':       ['【安定】'],
  '【計画】':       ['【安定】'],
  '【時間】':       ['【安定】'],

  // ── リーダー ──
  '【リーダー】':   ['【リーダー】'],
  '【壮大】':       ['【リーダー】'],
  '【守護】':       ['【リーダー】'],
  '【自立】':       ['【リーダー】'],
  '【社交】':       ['【リーダー】'],
  '【社交的】':     ['【リーダー】'],

  // ── 希望 ──
  '【希望】':       ['【希望】'],
  '【幸福】':       ['【希望】'],
  '【幸運】':       ['【希望】'],
  '【未来】':       ['【希望】'],
  '【成長】':       ['【希望】'],
  '【豊か】':       ['【希望】'],
  '【豊かさ】':     ['【希望】'],
  '【実り】':       ['【希望】'],
  '【始まり】':     ['【希望】'],

  // ── 精神 ──
  '【精神】':       ['【精神】'],
  '【純粋】':       ['【精神】'],
  '【個性】':       ['【精神】'],
  '【運命】':       ['【精神】'],
  '【唯一】':       ['【精神】'],
  '【静寂】':       ['【精神】'],

  // ── 追加マッピング ──
  '【自由】':       ['【希望】'],
  '【性格】':       ['【精神】'],

  // ── スキップ（意味が薄い or 分類困難）──
  '【その他】':     [],
  '【車】':         [],
  '【形状】':       [],
  '【現在】':       [],
  '【経験】':       [],  // 上でも設定済み → 知性 に分類
};

// =========================================================
// 新タグベースの男女スコア
// 基準値50、タグごとにオフセット加算、0-100クランプ
// =========================================================
const NEW_TAG_GENDER = {
  '【自然】':   { male:  0, female:  0 },
  '【明るさ】': { male: -5, female: 10 },
  '【水】':     { male:  5, female:  5 },
  '【力強さ】': { male: 35, female:-20 },
  '【優しさ】': { male:-15, female: 20 },
  '【知性】':   { male:  5, female:  5 },
  '【誠実】':   { male: 10, female:  0 },
  '【品格】':   { male: -5, female: 15 },
  '【伝統】':   { male:  0, female:  0 },
  '【美しさ】': { male:-25, female: 35 },
  '【成功】':   { male: 15, female: -5 },
  '【安定】':   { male:  5, female:  5 },
  '【リーダー】':{ male: 25, female:-10 },
  '【希望】':   { male:  0, female:  5 },
  '【精神】':   { male:  0, female:  5 },
};

// =========================================================
// メイン処理
// =========================================================
var raw = fs.readFileSync(DATA_PATH, 'utf8');
var data = JSON.parse(raw);

var unknownTags = {};
var tagDistribution = {};

data.forEach(function(entry) {
  var bunrui = entry['分類'] || '';
  var oldTags = bunrui.match(/【[^】]+】/g) || [];

  // 旧タグ → 新タグ変換（重複除去）
  var newTagSet = {};
  oldTags.forEach(function(oldTag) {
    if (OLD_TO_NEW.hasOwnProperty(oldTag)) {
      (OLD_TO_NEW[oldTag] || []).forEach(function(newTag) {
        newTagSet[newTag] = true;
      });
    } else {
      unknownTags[oldTag] = (unknownTags[oldTag] || 0) + 1;
    }
  });

  var newTagsArray = Object.keys(newTagSet);

  // 分類フィールドを上書き
  entry['分類'] = newTagsArray.join('');

  // 新タグ分布カウント
  newTagsArray.forEach(function(t) {
    tagDistribution[t] = (tagDistribution[t] || 0) + 1;
  });

  // 男女おすすめ度再計算
  var BASE = 50;
  var maleOffset = 0;
  var femaleOffset = 0;
  newTagsArray.forEach(function(tag) {
    var g = NEW_TAG_GENDER[tag];
    if (g) {
      maleOffset += g.male;
      femaleOffset += g.female;
    }
  });
  entry['男のおすすめ度'] = Math.max(0, Math.min(100, BASE + maleOffset));
  entry['女のおすすめ度'] = Math.max(0, Math.min(100, BASE + femaleOffset));
});

fs.writeFileSync(DATA_PATH, JSON.stringify(data, null, 2), 'utf8');

console.log('完了: 全', data.length, '件 更新');

if (Object.keys(unknownTags).length > 0) {
  console.log('\n未定義タグ（要確認）:', JSON.stringify(unknownTags, null, 2));
} else {
  console.log('未定義タグ: なし');
}

console.log('\n=== 新タグ分布 ===');
var sorted = Object.entries(tagDistribution).sort(function(a,b){return b[1]-a[1];});
sorted.forEach(function(pair) {
  console.log(' ', pair[0], ':', pair[1], '件');
});

console.log('\n--- サンプル確認 ---');
['花', '一', '刀', '智', '愛', '月'].forEach(function(k) {
  var entry = data.find(function(d){ return d['漢字'] === k; });
  if (entry) {
    console.log(k, '分類:', entry['分類'], '| 男:', entry['男のおすすめ度'], '女:', entry['女のおすすめ度']);
  }
});
