/* ============================================================
   MODULE 03: FORTUNE (V13.0)
   姓名判断ロジック（五格・三才・五行）
   ============================================================ */

const FortuneLogic = (function () {

    /**
     * 五行の取得（末尾数字から判定）
     */
    const getGogyo = (num) => {
        const n = num % 10;
        if (n === 1 || n === 2) return { name: "木", type: "Wood" };
        if (n === 3 || n === 4) return { name: "火", type: "Fire" };
        if (n === 5 || n === 6) return { name: "土", type: "Earth" };
        if (n === 7 || n === 8) return { name: "金", type: "Metal" };
        return { name: "水", type: "Water" };
    };

    /**
     * 三才の相性判定
     */
    const getSansaiLuck = (ten, jin, chi) => {
        const t = getGogyo(ten).name;
        const j = getGogyo(jin).name;
        const c = getGogyo(chi).name;

        // 相生関係（良い組み合わせ）
        const sosei = [
            "木火", "火土", "土金", "金水", "水木", // 相生
            "木木", "火火", "土土", "金金", "水水"  // 同行
        ];

        const isTenJinGood = sosei.includes(t + j) || sosei.includes(j + t);
        const isJinChiGood = sosei.includes(j + c) || sosei.includes(c + j);

        if (isTenJinGood && isJinChiGood) {
            return { l: "大吉", desc: "三才の配置が完璧です。バランスの取れた運勢。" };
        } else if (isTenJinGood || isJinChiGood) {
            return { l: "吉", desc: "良好なバランスです。安定した運勢。" };
        } else {
            return { l: "中吉", desc: "独自の個性が光る配置です。努力次第で開運。" };
        }
    };

    /**
     * 画数別の吉凶データ
     */
    const luckData = {
        1: { l: "大吉", r: "独立心と行動力に溢れ、万物を始動させる強力なエネルギーを持っています。リーダーとしての資質に恵まれるでしょう。" },
        2: { l: "凶", r: "変化や動揺が多く、安定しにくい運勢です。不安や迷いが生じやすいですが、精神的な強さを養うことで乗り越えられます。" },
        3: { l: "大吉", r: "知恵と行動力を兼ね備え、周囲の信頼を集めて発展していく運勢です。明るい未来を切り開く力を持っています。" },
        4: { l: "凶", r: "困難や苦労が多く、意志がくじけそうになることも。コツコツと努力を積み重ねることで、道が開ける可能性があります。" },
        5: { l: "大吉", r: "協調性と柔軟性を持ち、周囲との調和を大切にします。穏やかで信頼され、安定した人生を築くことができるでしょう。" },
        6: { l: "大吉", r: "天からの恵みを受け、多くの支援やチャンスに恵まれます。感謝の心を忘れなければ、幸福な人生を歩めます。" },
        7: { l: "吉", r: "強い意志と独立心を持ち、自力で困難を突破する力があります。独りよがりにならず、周囲と協力すれば更に発展します。" },
        8: { l: "吉", r: "不屈の精神力を持ち、どんな困難にも負けずに目標を達成します。地道な努力が実を結ぶ、大器晩成型の運勢です。" },
        9: { l: "凶", r: "感受性が鋭く、芸術的な才能に恵まれますが、精神的な孤独や悩みを抱えやすい傾向があります。" },
        10: { l: "凶", r: "努力しても空回りしやすく、成果が出にくい運勢です。焦らず着実に足元を固めることが大切です。" },
        11: { l: "大吉", r: "一度つまずいても必ず立ち上がる、強い生命力と再起力を持っています。着実に地位を築いていくでしょう。" },
        12: { l: "凶", r: "意志が弱く、周囲に流されやすい傾向があります。自分の芯をしっかり持ち、目標に向かって継続することが課題です。" },
        13: { l: "大吉", r: "優れた知性と直感力を持ち、学問や芸術の分野で才能を発揮します。チャンスを逃さず成功を掴む力があります。" },
        14: { l: "凶", r: "人間関係のトラブルや家族間の問題に悩まされやすい運勢です。思いやりと忍耐力を持つことが開運の鍵です。" },
        15: { l: "大吉", r: "温厚で誠実な人柄が愛され、周囲からの協力や引き立てを得て成功します。家庭運にも恵まれるでしょう。" },
        16: { l: "大吉", r: "リーダーシップと包容力を持ち、多くの人々から慕われます。組織のトップに立つ資質があり、大成する運勢です。" },
        17: { l: "吉", r: "信念を貫く強い意志と行動力があります。頑固になりすぎず、柔軟性を持てば大きな成功を収めるでしょう。" },
        18: { l: "吉", r: "実行力と統率力に優れ、困難を乗り越えて目的を達成します。信頼され、責任ある立場を任されることが多いです。" },
        19: { l: "凶", r: "才能には恵まれますが、予期せぬトラブルや障害に阻まれやすい運勢です。慎重な行動と冷静な判断が必要です。" },
        20: { l: "凶", r: "努力が報われにくく、不運が重なりやすい傾向があります。健康管理に気をつけ、堅実な生活を心がけましょう。" },
        21: { l: "大吉", r: "独立心が旺盛で、自らの力で道を切り開く指導者タイプです。女性は仕事で成功する反面、家庭運に注意が必要です。" },
        22: { l: "凶", r: "外見は華やかでも内面は脆く、途中で挫折しやすい運勢です。地道な努力を続ける粘り強さが求められます。" },
        23: { l: "大吉", r: "旭日が昇るような勢いで運気が上昇し、若くして成功を収める可能性があります。エネルギッシュで活動的です。" },
        24: { l: "大吉", r: "金運や財運に恵まれ、物質的な豊かさを手に入れることができます。才色兼備で周囲からの人気も高いでしょう。" },
        25: { l: "吉", r: "個性が強く、独自の道を突き進む才能があります。協調性を意識すれば、周囲と良い関係を築けるでしょう。" },
        26: { l: "凶", r: "波乱に満ちた人生になりやすく、英雄的な成功か大きな挫折か、極端な結果になりがちです。" },
        27: { l: "凶", r: "プライドが高く攻撃的な面があり、対人関係で孤立しやすい傾向があります。謙虚さと協調性が成功の鍵です。" },
        28: { l: "凶", r: "才能豊かですが、環境の変化や移り変わりに翻弄されやすい運勢です。家族との絆を大切にしましょう。" },
        29: { l: "大吉", r: "知略と戦略に優れ、知的な分野で大きな成功を収めます。権力志向が強いですが、実力で地位を築きます。" },
        30: { l: "凶", r: "運気の浮き沈みが激しく、良い時と悪い時の差が極端です。一喜一憂せず、平常心を保つことが大切です。" },
        31: { l: "大吉", r: "知性、仁徳、勇気を兼ね備え、あらゆる分野でリーダーシップを発揮します。調和のとれた素晴らしい運勢です。" },
        32: { l: "大吉", r: "思いがけない幸運やチャンスに恵まれる「棚ぼた」的な強運を持っています。素直な心でチャンスを活かしましょう。" },
        33: { l: "大吉", r: "自信と野心に溢れ、困難を打ち破って頂点を目指す強いエネルギーを持っています。トップに立つ器です。" },
        34: { l: "凶", r: "予期せぬ災難や困難に見舞われやすい運勢です。慎重さとリスク管理を徹底し、堅実な道を歩むことが重要です。" },
        35: { l: "吉", r: "温和で平和を愛し、学問や芸術などの静かな分野で才能を発揮します。女性にとっては特に良い良妻賢母の運です。" },
        36: { l: "凶", r: "正義感が強く行動的ですが、波乱に巻き込まれやすい運勢です。短気を起こさず、冷静さを保つことが大切です。" },
        37: { l: "大吉", r: "独立独歩で道を切り開き、着実に成功を積み重ねていく大器晩成型です。信頼と実力で地位を築きます。" },
        38: { l: "吉", r: "手先が器用で、技術や芸術の分野で優れた才能を発揮します。派手さはありませんが、着実な発展が望めます。" },
        39: { l: "大吉", r: "徳と才能に恵まれ、多くの人々を導くリーダーとして繁栄します。女性は仕事に生きるほうが能力を発揮できます。" },
        40: { l: "凶", r: "知恵はありますが、独断専行になりやすく、周囲の反発を招くことがあります。謙虚な態度を心がけましょう。" },
        41: { l: "大吉", r: "冷静な判断力と大胆な行動力を持ち、実業界や指導的立場で成功を収めます。健全な野心を持つ大吉数です。" },
        42: { l: "凶", r: "器用貧乏になりやすく、多才ゆえに一つに定まらない傾向があります。目標を一つに絞り、粘り強く取り組むこと。" },
        43: { l: "凶", r: "見かけは華やかでも内実は苦労が多く、金銭面や異性関係のトラブルに注意が必要です。堅実さが身を助けます。" },
        44: { l: "凶", r: "神経質で悩みが多く、精神的な不安定さを抱えやすい運勢です。心身の健康を第一に考え、リラックスを心がけて。" },
        45: { l: "大吉", r: "順風満帆な運勢で、困難があっても自然と道が開けていきます。知恵と徳を備え、大きな成功を掴むでしょう。" },
        46: { l: "凶", r: "意志が弱く流されやすいため、チャンスを逃しやすい傾向があります。自ら積極的に行動することで運が開けます。" },
        47: { l: "大吉", r: "人徳と才能に恵まれ、周囲の協力で大きな花を咲かせます。努力が正当に評価され、幸福な人生を送れるでしょう。" },
        48: { l: "大吉", r: "知恵と徳を兼ね備え、人々の相談役や指導者として尊敬を集めます。実利よりも名誉を得る運勢です。" },
        49: { l: "凶", r: "吉凶が入り混じり、変化の激しい波瀾万丈な人生になりがちです。柔軟な対応力が求められます。" },
        50: { l: "凶", r: "一時は成功しても長続きせず、晩年に運気が下降する恐れがあります。成功した時こそ謙虚さを忘れずに。" },
        51: { l: "吉", r: "晩年になるほど運気が上昇し、穏やかで幸福な余生を送ることができます。焦らず着実に努力を続けましょう。" },
        52: { l: "大吉", r: "先見の明があり、時代の流れを読んで成功を収めます。投機的な才能もありますが、堅実さも忘れずに。" },
        53: { l: "凶", r: "外見は良くても内面には悩みや不満を抱えやすい運勢です。見栄を張らず、ありのままの自分を大切にしましょう。" },
        54: { l: "凶", r: "孤立しやすく、周囲との協調性に欠ける傾向があります。和を大切にし、感謝の気持ちを表すことが開運の鍵です。" },
        55: { l: "凶", r: "チャンスは訪れますが、決断力不足で逃してしまいがちです。自信を持って行動すれば、道は開けるでしょう。" },
        56: { l: "凶", r: "積極性に欠け、チャンスがきても尻込みしてしまう傾向があります。失敗を恐れず挑戦する勇気を持ちましょう。" },
        57: { l: "吉", r: "一度決めたことは最後までやり遂げる、強い意志と忍耐力を持っています。苦労の末に必ず成功を掴むでしょう。" },
        58: { l: "吉", r: "七転び八起きの精神で、何度失敗しても立ち上がる強さがあります。晩年には大きな実りを手にするでしょう。" },
        59: { l: "凶", r: "忍耐力がなく、飽きっぽい性格のため、物事が長続きしにくい傾向があります。継続する力を養いましょう。" },
        60: { l: "凶", r: "何事も思うように進まず、先が見えない不安に悩まされやすい運勢です。焦らず、目の前の課題に取り組むこと。" },
        61: { l: "吉", r: "名誉や地位を重んじ、努力して社会的成功を目指します。高慢にならなければ、周囲からの信頼も得られます。" },
        62: { l: "凶", r: "孤独を感じやすく、人間関係で悩むことが多い運勢です。積極的に人と関わり、心を開くことが大切です。" },
        63: { l: "大吉", r: "順調な運勢で、物質的にも精神的にも恵まれます。平穏で安泰な人生を送れるでしょう。" },
        64: { l: "凶", r: "突然のトラブルや急変に巻き込まれやすく、波乱含みの運勢です。常にリスク管理を意識しましょう。" },
        65: { l: "大吉", r: "長寿と繁栄に恵まれ、家庭的にも社会的にも幸福な人生を送れます。吉数の中でも特に安定した運勢です。" },
        66: { l: "凶", r: "逆境に強く、困難を乗り越える力はありますが、平穏な時が少ない傾向があります。心の休息を大切に。" },
        67: { l: "大吉", r: "天からの導きを受け、全ての物事が順調に進む幸運な運勢です。感謝の心を持ち続ければ、さらに発展します。" },
        68: { l: "大吉", r: "発想力や創造力に優れ、新しい分野を開拓して成功します。独自のアイデアで周囲を驚かせるでしょう。" },
        69: { l: "凶", r: "精神的に不安定になりやすく、不安や迷いを抱えがちです。信頼できる相談相手を見つけると良いでしょう。" },
        70: { l: "凶", r: "虚栄心が強く、中身のない表面的な成功を追い求めがちです。地道な努力と謙虚さを大切にしましょう。" },
        71: { l: "吉", r: "若い頃の苦労が糧となり、晩年に向かって運気が開けていきます。努力が報われる大器晩成型です。" },
        72: { l: "凶", r: "家族縁が薄く、孤独感を抱きやすい傾向があります。血縁にこだわらず、心の通う人間関係を築きましょう。" },
        73: { l: "吉", r: "地味ながらも着実に努力を重ね、最終的に目的を達成します。誠実な人柄が評価されるでしょう。" },
        74: { l: "凶", r: "才能があっても不遇な環境に置かれやすく、なかなか芽が出ないことが。腐らずに実力を磨き続けましょう。" },
        75: { l: "吉", r: "慎重で用心深く、リスクを避けて安全な道を選びます。大きな失敗はないものの、大胆さも時には必要です。" },
        76: { l: "凶", r: "親族との不和や対立が生じやすく、精神的なストレスを感じやすい運勢です。寛容な心を持つことが大切です。" },
        77: { l: "吉", r: "前半生は苦労があっても、後半生で喜び事や成功に恵まれます。諦めずに前向きに進みましょう。" },
        78: { l: "吉", r: "晩年に向けて運気が安定し、穏やかで平穏な日々を送れるでしょう。健康に気をつければ長寿も望めます。" },
        79: { l: "凶", r: "困難な状況に陥りやすく、孤立無援になりがちです。意固地にならず、周囲に助けを求めることも必要です。" },
        80: { l: "凶", r: "病気や健康問題に悩まされやすい傾向があります。無理をせず、健康管理を最優先に生活しましょう。" },
        81: { l: "大吉", r: "全ての数が原点に戻るように、新たな始まりと完全な調和を表します。究極の吉数とされ、大いなる繁栄を約束します。" }
    };

    const defaultLuck = { l: "吉", r: "通常の運勢" };

    /**
     * メイン計算関数
     */
    return {
        calculate: function (surArr, givArr) {
            if (!surArr || surArr.length === 0) {
                console.warn("FORTUNE: Surname data is empty");
                surArr = [{ kanji: '', strokes: 0 }];
            }

            if (!givArr || givArr.length === 0) {
                console.error("FORTUNE: Given name data is empty");
                return null;
            }

            const surStrokes = surArr.map(s => s.strokes);
            const givStrokes = givArr.map(g => g.strokes);
            const surTotal = surStrokes.reduce((a, b) => a + b, 0);
            const givTotal = givStrokes.reduce((a, b) => a + b, 0);

            // 五格の計算
            const ten = surTotal || 1; // 天格（名字の総画数）
            const jin = (surStrokes[surStrokes.length - 1] || 0) + (givStrokes[0] || 0); // 人格
            const chi = givTotal; // 地格（名前の総画数）

            // 外格の計算
            let gai = (surTotal + givTotal) - jin;
            if (surStrokes.length === 1 && givStrokes.length === 1) {
                gai = 2; // 特殊ケース
            } else if (surStrokes.length === 1 || givStrokes.length === 1) {
                gai += 1; // 調整
            }

            const so = surTotal + givTotal; // 総格

            // 三才の判定
            const sansai = getSansaiLuck(ten, jin, chi);

            return {
                ten: this.wrap(ten, "【天格】祖先運"),
                jin: this.wrap(jin, "【人格】主運"),
                chi: this.wrap(chi, "【地格】初年運"),
                gai: this.wrap(gai, "【外格】対人運"),
                so: this.wrap(so, "【総格】総合運"),
                sansai: {
                    label: sansai.l,
                    desc: sansai.desc,
                    t: getGogyo(ten).name,
                    j: getGogyo(jin).name,
                    c: getGogyo(chi).name
                }
            };
        },

        /**
         * 画数を吉凶でラップ
         */
        wrap: function (val, role) {
            const targetVal = val > 81 ? (val % 81 || 81) : val;
            const luck = luckData[targetVal] || defaultLuck;

            let colorClass = "text-[#bca37f]";
            if (luck.l === "大吉") colorClass = "text-amber-600 font-black";
            else if (luck.l === "吉") colorClass = "text-[#81c995] font-bold";
            else if (luck.l === "凶") colorClass = "text-slate-500 font-bold";

            return {
                val: val,
                res: { label: luck.l, color: colorClass },
                role: role + " " + luck.r
            };
        }
    };
})();

console.log("FORTUNE: Module loaded");
